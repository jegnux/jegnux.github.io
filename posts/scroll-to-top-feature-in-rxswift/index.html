<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='In this post I&rsquo;ll write about how to implement a custom scroll to top feature with the ability to restore the old contentOffset. The first app I saw implementing this feature is TweetBot in its 4.8 update and it became instantly a must have for me.
While working on side-project application (stay tuned üòâ), I implemented this feature as well. Let&rsquo;s see how I did it entirely using RxSwift.'>

<meta property='og:title' content='Scroll to Top Feature in RxSwift ‚Ä¢ ‚ú® Elegant Programming in Swift'>
<meta property='og:description' content='In this post I&rsquo;ll write about how to implement a custom scroll to top feature with the ability to restore the old contentOffset. The first app I saw implementing this feature is TweetBot in its 4.8 update and it became instantly a must have for me.
While working on side-project application (stay tuned üòâ), I implemented this feature as well. Let&rsquo;s see how I did it entirely using RxSwift.'>
<meta property='og:url' content='https://jegnux.github.io/posts/scroll-to-top-feature-in-rxswift/'>
<meta property='og:site_name' content='‚ú® Elegant Programming in Swift'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:published_time' content='2018-01-28T09:23:08&#43;01:00'/><meta property='article:modified_time' content='2018-01-28T09:23:08&#43;01:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@jegnux'>

<meta name="generator" content="Hugo 0.32.4" />

  <title>Scroll to Top Feature in RxSwift ‚Ä¢ ‚ú® Elegant Programming in Swift</title>
  <link rel='canonical' href='https://jegnux.github.io/posts/scroll-to-top-feature-in-rxswift/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.f0e8df71.css'><link rel='stylesheet' href='/assets/css/custom.css'>
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-112418417-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>


<body class='page type-posts'>
  <div class='site'>

    <a class='screen-reader' href='#main'>Skip to Content</a>

    <header id='header' class='header-container'>
      <div class='header site-header'>
        <nav id='main-menu' class='main-menu-container' aria-label='Main Menu'>
  <ul class='main-menu'>
  <li>
      <a href='/'>Home</a>
    </li>
  <li>
      <a href='/about/'>About Me</a>
    </li>
  
  </ul>
</nav>

        <div class='header-info'>
          
          <p class='site-title title'>‚ú® Elegant Programming in Swift</p>
          
          <p class='site-description subtitle'></p>
        </div>
      </div>
    </header>


<main id='main' class='main'>
  <article lang='en' class='entry'>
    <header class='header-container'>
  <div class='header entry-header'>
    <div class='header-info'>
      <h1 class='title'>Scroll to Top Feature in RxSwift</h1>
      

    </div>
    
<div class='meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader'>Posted on </span>
  <time class='date' datetime='2018-01-28T09:23:08&#43;01:00'>2018, Jan 28</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
8 mins read
</span>


</div>


  </div>
</header>

    
    

    <div class='entry-content'>
  

<p>In this post I&rsquo;ll write about how to implement a custom <strong>scroll to top</strong> feature with the ability to restore the old <code>contentOffset</code>. The first app I saw implementing this feature is <a href="https://tapbots.com/tweetbot/">TweetBot</a> in its <a href="https://itunes.apple.com/fr/app/tweetbot-4-for-twitter/id1018355599?mt=8">4.8 update</a> and it became instantly a must have for me.</p>

<p>While working on side-project application (stay tuned üòâ), I implemented this feature as well. Let&rsquo;s see how I did it entirely using <strong>RxSwift</strong>.</p>

<h2 id="rxswift">‚ú® RxSwift</h2>

<p>My <em>love</em> for RxSwift began mid 2016 when I joined <a href="https://jobs.lever.co/heetch/03875a59-c16f-4425-8161-288499837167">Heetch</a>. Since then, it allows me to write complex features in such a simple, expressive, and readable way. I think I will speak about <strong>RxSwift</strong> often on this blog, because it definitely helps to write elegant code IMHO.</p>

<p>The <strong>scroll to top</strong> is usually triggered by a tap on the status bar, but as it will be implemented here it will also be possible to add new sources to trigger. For instance a tap on tab bar item, on <code>viewWillAppear</code>, or on everything else as soon as it&rsquo;s an <code>Observable</code>. The beauty of <strong>RxSwift</strong> is to offer a uniform interface for many design pattern of Cocoa (delegate, target/action, notifications, callback closures, etc.).</p>

<h2 id="implementation">Implementation</h2>

<h3 id="the-recipe">The recipe</h3>

<ol>
<li>Implement an <code>Observable&lt;Void&gt;</code> that emits whenever the user tap on the <code>UIApplication.shared.keyWindow</code> in status bar&rsquo;s frame</li>
<li>Associate 1. to a <code>UIViewController</code> and filter its events to emit them if and only if the <code>UIViewController</code> instance is visible (ie. between <code>viewDidAppear</code> and <code>viewWillDisappear</code> lifecycle events)</li>
<li>Implement a <code>ScrollTarget</code> enum to let switch over different target (either <code>.top</code> or <code>.offset(CGFloat)</code></li>
<li>Implement an <code>Observable</code> that emits whenever the user has finished to scroll an <code>UIScrollView</code> in order to save the current <code>contentOffset</code> into <code>ScrollTarget.offset(contentOffset.y)</code></li>
<li>Implement the final subscription that combine 2. and 4. to scroll the <code>UIScrollView</code> to the desired target.</li>
</ol>

<h3 id="prerequisites">Prerequisites</h3>

<p>For the implementation I used <code>RxSwift</code>, <code>RxCocoa</code> and <code>RxSwiftExt</code>.
There&rsquo;s also two little Rx extension I use.</p>

<p>The first one transforms any <code>Observable&lt;E&gt;</code> into <code>Observable&lt;Void&gt;</code>. It&rsquo;s quite convenient when we don&rsquo;t need the value. Typically when you use the <code>Observable</code> as a sampler.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style=";border-spacing:0;padding:0;margin:0;border:0;width:100%;overflow:auto;display:block;"><tr><td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">1</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">2</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">3</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">4</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">5</span></code></pre></td>
<td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">extension</span> <span style="color:#a6e22e">ObservableType</span> {
  <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">void</span>() -&gt; Observable&lt;Void<span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">return</span> map { <span style="color:#66d9ef">_</span> <span style="color:#66d9ef">in</span> }
  }
}</code></pre></td></tr></table>
</div>
</div>
<p>The second is a <code>startWith</code> operator that takes a closure instead of a value. It avoids a strong reference on the initial value.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style=";border-spacing:0;padding:0;margin:0;border:0;width:100%;overflow:auto;display:block;"><tr><td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">1</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">2</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">3</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">4</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">5</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">6</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">7</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">8</span></code></pre></td>
<td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">extension</span> <span style="color:#a6e22e">ObservableType</span> {
  <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">startWith</span>(<span style="color:#66d9ef">_</span> factory: @escaping () -&gt; Observable&lt;E<span style="color:#f92672">&gt;</span>) -&gt; Observable&lt;E<span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">let</span> start = Observable&lt;E<span style="color:#f92672">&gt;</span>.deferred {
      factory()
    }
    <span style="color:#66d9ef">return</span> start.concat(<span style="color:#66d9ef">self</span>)
  }
}</code></pre></td></tr></table>
</div>
</div>
<h3 id="1-detect-tap-on-status-bar">1. Detect tap on status bar</h3>

<p>To do this without any subclassing, <code>RxCocoa</code> will be a precious help.</p>

<p>First let&rsquo;s make an <code>Observable&lt;UIWindow?&gt;</code> that emits the <code>keyWindow</code> of <code>UIApplication.shared</code>.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style=";border-spacing:0;padding:0;margin:0;border:0;width:100%;overflow:auto;display:block;"><tr><td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 1</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 2</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 3</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 4</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 5</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 6</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 7</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 8</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 9</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">10</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">11</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">12</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">13</span></code></pre></td>
<td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">extension</span> <span style="color:#a6e22e">Reactive</span> <span style="color:#66d9ef">where</span> Base: UIApplication {
  <span style="color:#66d9ef">var</span> keyWindow: Observable&lt;UIWindow?<span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">return</span> NotificationCenter.<span style="color:#66d9ef">default</span>.rx
      .notification(.UIWindowDidBecomeKey, object: <span style="color:#66d9ef">nil</span>)
      .map { notification -&gt; UIWindow? <span style="color:#66d9ef">in</span>
        notification.object <span style="color:#66d9ef">as</span>? UIWindow
      }
      .startWith { [<span style="color:#66d9ef">weak</span> base] <span style="color:#66d9ef">in</span>
        <span style="color:#66d9ef">guard</span> <span style="color:#66d9ef">let</span> base = base <span style="color:#66d9ef">else</span> { <span style="color:#66d9ef">return</span> .empty() }
        <span style="color:#66d9ef">return</span> .just(base.keyWindow)
      }
  }
}</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>On <strong>lines 3 to 6</strong> we listen for <code>UIWindowDidBecomeKey</code> notification and get the associated object (the window) once a notification is posted</li>
<li>On <strong>lines 8 to 11</strong> we use the current <code>base.keyWindow</code> as a start value</li>
</ul>

<p>Now we always have the latest <code>keyWindow</code> we can flatMap over it to detect when user tap in it. The best way to do this is to attach an <code>UITapGestureRecognizer</code> to the window. It would be really easy to do with <code>RxGesture</code> for example.</p>

<p>Unfortunately, the view system on iOS won&rsquo;t deliver the touch event to any gesture recognizer if touch location is in status bar&rsquo;s frame.
The only way I found to bypass this limitation is to intercept the invocation of:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style=";border-spacing:0;padding:0;margin:0;border:0;width:100%;overflow:auto;display:block;"><tr><td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">1</span></code></pre></td>
<td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">point</span>(inside: CGPoint, with: UIEvent?)</code></pre></td></tr></table>
</div>
</div>
<p>And <code>RxCocoa</code> have a powerful built-in <code>.methodInvoked()</code> operator to do this.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style=";border-spacing:0;padding:0;margin:0;border:0;width:100%;overflow:auto;display:block;"><tr><td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 1</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 2</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 3</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 4</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 5</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 6</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 7</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 8</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 9</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">10</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">11</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">12</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">13</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">14</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">15</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">16</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">17</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">18</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">19</span></code></pre></td>
<td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">extension</span> <span style="color:#a6e22e">ObservableType</span> {
  <span style="color:#66d9ef">var</span> statusBarTap: Observable&lt;Void<span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">return</span> keyWindow
      .flatMapLatest { window -&gt; Observable&lt;CGPoint<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">in</span>
        <span style="color:#66d9ef">guard</span> <span style="color:#66d9ef">let</span> window = window <span style="color:#66d9ef">else</span> { <span style="color:#66d9ef">return</span> .empty() }
        <span style="color:#66d9ef">return</span> window.rx.methodInvoked(<span style="color:#66d9ef">#selector</span>(UIView.point(inside:with:)))
          .map { arg -&gt; CGPoint? <span style="color:#66d9ef">in</span>
            <span style="color:#66d9ef">return</span> arg.first <span style="color:#66d9ef">as</span>? CGPoint
          }
          .unwrap()
      }
      .debug()
      .filter { [<span style="color:#66d9ef">unowned</span> app = <span style="color:#66d9ef">self</span>.base] point <span style="color:#66d9ef">in</span>
        point.y <span style="color:#f92672">&lt;</span> app.statusBarFrame.maxY <span style="color:#f92672">+</span> <span style="color:#ae81ff">20</span>
      }
      .void()
      .debounce(<span style="color:#ae81ff">0</span>, scheduler: MainScheduler.asyncInstance)
  }
}</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>On <strong>line 3</strong> we use the <code>keyWindow: Observable&lt;UIWindow?&gt;</code> defined earlier.</li>
<li>On <strong>lines 6 to 10</strong> we use the <code>.methodInvoked()</code> operator to intercept the invocation and <code>map</code> over it to get the point location of the touch event. Absolutely, it would be safe to force unwrap with <code>return arg.first as! CGPoint</code> because we <em>know</em> the exact method signature, but I still prefer to keep the optional and unwrap it with <a href="https://github.com/RxSwiftCommunity/RxSwiftExt#unwrap"><code>.unwrap()</code></a> operator of <code>RxSwiftExt</code>.</li>
<li>On <strong>line 14</strong> you can notice that I add an extra <code>20pt</code> to the <code>statusBarFrame</code>. It makes the tappable target a little bit higher. <a href="https://lawsofux.com/fittss-law.html">M. Fitts</a> approves it üëç.</li>
<li>On <strong>line 17</strong>, we use the <code>.debounce()</code> operator with a delay of <code>0</code> and an async instance of the <code>MainScheduler</code>. It&rsquo;s important because <code>UIView.point(inside:with:)</code> will be called many times during the same run loop, so we need to filter repetitive events. You can see this as similar to an other UIKit pattern like <code>setNeedsDisplay()</code> / <code>displayIfNeeded()</code></li>
</ul>

<p>Congratulations, you&rsquo;re done with the first step üòå</p>

<h3 id="2-detect-status-bar-tap-on-a-visible-viewcontroller">2. Detect status bar tap on a visible ViewController</h3>

<p>As you will likely use this feature on a <code>UIScrollView</code> included in a specific <code>UIViewController</code>, you better make sure that this <code>UIViewController</code> is actually visible before reacting to this event.</p>

<p>Otherwise, imagine you have several <code>UIViewController</code> in a <code>UITabBarController</code> implementing this gesture. If you don&rsquo;t bound the event to each <code>UIViewController</code>&rsquo;s visibility, a tap on the status bar will scroll to top all <code>UIScollView</code> of each view controllers. We obviously don&rsquo;t want this.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style=";border-spacing:0;padding:0;margin:0;border:0;width:100%;overflow:auto;display:block;"><tr><td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 1</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 2</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 3</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 4</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 5</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 6</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 7</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 8</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 9</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">10</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">11</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">12</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">13</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">14</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">15</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">16</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">17</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">18</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">19</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">20</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">21</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">22</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">23</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">24</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">25</span></code></pre></td>
<td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">extension</span> <span style="color:#a6e22e">Reactive</span> <span style="color:#66d9ef">where</span> Base: UIViewController {
  <span style="color:#66d9ef">var</span> statusBarTap: Observable&lt;Void<span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">let</span> isVisible: Observable&lt;Bool<span style="color:#f92672">&gt;</span> = Observable
    .merge(
      methodInvoked(<span style="color:#66d9ef">#selector</span>(
      	UIViewController.viewWillAppear(<span style="color:#66d9ef">_</span>:)
      )).map(to: <span style="color:#66d9ef">false</span>),

      methodInvoked(<span style="color:#66d9ef">#selector</span>(
      	UIViewController.viewDidAppear(<span style="color:#66d9ef">_</span>:)
      )).map(to: <span style="color:#66d9ef">true</span>),

      methodInvoked(<span style="color:#66d9ef">#selector</span>(
      	UIViewController.viewWillDisappear(<span style="color:#66d9ef">_</span>:)
      )).map(to: <span style="color:#66d9ef">false</span>),

      methodInvoked(<span style="color:#66d9ef">#selector</span>(
      	UIViewController.viewDidDisappear(<span style="color:#66d9ef">_</span>:)
     	)).map(to: <span style="color:#66d9ef">false</span>)
    )
    <span style="color:#66d9ef">return</span> UIApplication.shared.rx
      .statusBarTap
      .pausable(isVisible)
  }
}</code></pre></td></tr></table>
</div>
</div>
<p>Once again, <code>RxCocoa</code>&rsquo;s <code>.methodInvoked()</code> operator is a great help as it allows us to intercept appearance lifecycle methods and map them to a boolean indicating if the view controller is visible or not. Here, <code>viewDidAppear</code> is mapped to <code>true</code> (line 11) and other methods are mapped to <code>false</code>.</p>

<p>To finish, we reuse <code>UIApplication.shared.rx.statusBarTap</code> we created earlier and use the <a href="https://github.com/RxSwiftCommunity/RxSwiftExt#pausable"><code>.pausable()</code></a> operator of <code>RxSwiftExt</code> in order to emit values only if latest value from <code>isVisible</code> is <code>true</code>.</p>

<h3 id="3-scrolltarget">3. ScrollTarget</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style=";border-spacing:0;padding:0;margin:0;border:0;width:100%;overflow:auto;display:block;"><tr><td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">1</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">2</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">3</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">4</span></code></pre></td>
<td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">ScrollTarget</span> {
  <span style="color:#66d9ef">case</span> top
  <span style="color:#66d9ef">case</span> offset(CGFloat)
}</code></pre></td></tr></table>
</div>
</div>
<p>Done üí•</p>

<h3 id="4-save-contentoffset-after-scroll">4. Save contentOffset after scroll</h3>

<blockquote>
<p>Starting from here, I will simplify and write all the code we need in our <code>UIViewController</code>&rsquo;s <code>viewDidLoad()</code>. I will also assume there are a <code>scrollView</code> and a <code>disposeBag</code> around there.</p>
</blockquote>

<p>Let&rsquo;s start with the code.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style=";border-spacing:0;padding:0;margin:0;border:0;width:100%;overflow:auto;display:block;"><tr><td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 1</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 2</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 3</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 4</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 5</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 6</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 7</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 8</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 9</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">10</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">11</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">12</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">13</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">14</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">15</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">16</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">17</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">18</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">19</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">20</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">21</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">22</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">23</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">24</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">25</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">26</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">27</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">28</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">29</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">30</span></code></pre></td>
<td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">viewDidLoad</span>() {
  <span style="color:#66d9ef">super</span>.viewDidLoad()

  <span style="color:#66d9ef">let</span> target = BehaviorSubject(value: ScrollTarget.top)

  <span style="color:#66d9ef">let</span> source = <span style="color:#66d9ef">self</span>.rx.statusBarTap.withLatestFrom(target).share()

  <span style="color:#75715e">// Save</span>
  source
    .map { [<span style="color:#66d9ef">unowned</span> scrollView] target -&gt; ScrollTarget <span style="color:#66d9ef">in</span>
      <span style="color:#66d9ef">switch</span> target {
      <span style="color:#66d9ef">case</span> .top:
        <span style="color:#66d9ef">return</span> .offset(scrollView.contentOffset.y)
      <span style="color:#66d9ef">case</span> .offset:
        <span style="color:#66d9ef">return</span> .top
      }
    }
    .bind(to: target)
    .disposed(by: disposeBag)

  <span style="color:#75715e">// Reset</span>
  scrollView.rx
    .willBeginDragging
    .map(to: .top)
    .bind(to: target)
    .disposed(by: disposeBag)

  <span style="color:#75715e">// To be continued...</span>

}</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>On <strong>line 4</strong> we create a <code>BehaviorSubject</code> that will hold our next <code>ScrollTarget</code>. The initial target will obviously be <code>.top</code>.</li>
<li>On <strong>line 6</strong> we prepare our source. It&rsquo;s just the <code>UIViewController.rx.statusBarTap</code> we created earlier, combined with the next target, and we finish with a <code>share()</code>. It&rsquo;s important to share here because as on <strong>line 27</strong> we update the target, we want to be sure that the subscription to actually <em>scrolls</em> the scroll view, use the correct target.</li>
<li>On <strong>lines 8 to 19</strong> we save the next target. If current target was <code>.top</code>, then the next target will be <code>.offset</code> with the current <code>scrollView</code> offset. Otherwise, the next target will be <code>.top</code>. This allows us to alternatively use one target or the other.</li>
<li>On <strong>lines 22 to 28</strong> we add a mechanism that reset the next target to <code>.top</code> as soon as the user interacts with the <code>scrollView</code>, because it wouldn&rsquo;t make sense to restore the old offset.</li>
</ul>

<h3 id="5-the-final-piece">5. The final piece</h3>

<p>Now we can implement the actual scrolling.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style=";border-spacing:0;padding:0;margin:0;border:0;width:100%;overflow:auto;display:block;"><tr><td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 1</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 2</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 3</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 4</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 5</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 6</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 7</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 8</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 9</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">10</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">11</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">12</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">13</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">14</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">15</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">16</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">17</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">18</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">19</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">20</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">21</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">22</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">23</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">24</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">25</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">26</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;display:block;">27</span></code></pre></td>
<td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">viewDidLoad</span>() {
  <span style="color:#75715e">// ...</span>

  <span style="color:#66d9ef">let</span> source = ...

  <span style="color:#75715e">// Save</span>
  <span style="color:#75715e">// ...</span>

  <span style="color:#75715e">// Reset</span>
  <span style="color:#75715e">// ...</span>

  source
    .map { target -&gt; CGFloat <span style="color:#66d9ef">in</span>
      <span style="color:#66d9ef">switch</span> target {
      <span style="color:#66d9ef">case</span> .top:
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>scrollView.adjustedContentInset.top
      <span style="color:#66d9ef">case</span> .offset(<span style="color:#66d9ef">let</span> offset):
        <span style="color:#66d9ef">return</span> offset
      }
    }
    .subscribe(onNext: { [<span style="color:#66d9ef">unowned</span> scrollView] offset <span style="color:#66d9ef">in</span>
        <span style="color:#66d9ef">var</span> contentOffset = scrollView.contentOffset
        contentOffset.y = offset
        scrollView.setContentOffset(contentOffset, animated: <span style="color:#66d9ef">true</span>)
    })
    .disposed(by: disposeBag)
}</code></pre></td></tr></table>
</div>
</div>
<p>No big deal here, we just get the good offset for each <code>ScrollTarget</code> cases and we animate the <code>scrollView.contentOffset</code> update.</p>

<p><center><big><strong>That&rsquo;s all üéâ</strong></big></center></p>

<hr />

<p>To conclude, we&rsquo;ve seen some interesting techniques offered by <strong>RxSwift</strong> and <strong>RxCocoa</strong> that allowed us to <span class="green">compose</span> an interesting feature without <span class="red">subclassing</span>, or using a <span class="red">mutable shared state</span>.</p>

<p>Starting from here, you could wrap everything somewhere to make it easily reusable on any <code>UIViewController</code> / <code>UIScrollView</code>.</p>

<p>Though, there are some trade-offs because we use some <code>RxCocoa</code> features that depends on Objective-C runtime and despite we don&rsquo;t use any private methods, you still should be careful when you use such techniques.</p>

<p>I hope you enjoyed reading this blog post / tutorial. Please do not hesitate to add a comment to tell me what you thought about it, to ask me some questions, or even to suggest me an idea for a future post where I could try to make an obscure solution more elegant üòâ</p>

</div>

    
<footer class='entry-footer-container'>
  <div class='entry-footer'>
  
  </div>
</footer>


  </article>
  
<nav class='entry-nav-container'>
  <div class='entry-nav'><div class='prev-entry'>
      <a href='/posts/equatable-on-enum-associated-values/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader'>Previous post: </span>Equatable on Enum Associated Values</a>
    </div></div>
</nav>

  
<div class='comments-container'>
  <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jegnux-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

</main>

    <footer id='footer' class='footer-container'>
      <div class='footer'>
        <div class='social-menu-container'>
  <nav aria-label='Social Menu'>
    <ul class='social-menu'><li>
        <a href='https://github.com/jegnux' target='_blank' rel='noopener'>
          <span class='screen-reader'>Open Github account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
</a>
      </li><li>
        <a href='https://twitter.com/jegnux' target='_blank' rel='noopener'>
          <span class='screen-reader'>Open Twitter account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
  
</svg>
</a>
      </li><li>
        <a href='mailto:j.alves@me.com' target='_blank' rel='noopener'>
          <span class='screen-reader'>Contact via Email</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>
</a>
      </li><li>
        <a href='https://linkedin.com/in/jeromealves' target='_blank' rel='noopener'>
          <span class='screen-reader'>Open Linkedin account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
  
</svg>
</a>
      </li></ul>
  </nav>
</div>
        <div class='copyright'>
  <p>
        
      

       &copy; 2018 J√©r√¥me Alves 
  </p>
</div>

      </div>
    </footer>

  </div><script src='/assets/js/main.5871befd.js'></script></body>

</html>

